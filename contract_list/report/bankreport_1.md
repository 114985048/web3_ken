# Bank 合约 Gas 使用分析报告

## 合约概述
Bank 合约是一个存款管理系统，维护用户存款余额并跟踪前 10 名存款用户。合约使用链表数据结构来高效管理排序后的用户列表。

## Gas 使用分析

### 1. 存储变量 Gas 成本

| 变量类型 | 变量名 | Gas 成本 | 说明 |
|---------|--------|----------|------|
| mapping | balances | 20,000 gas (首次写入) | 存储用户存款余额 |
| mapping | topUsers | 20,000 gas (首次写入) | 存储前10名用户链表节点 |
| address | head | 20,000 gas (首次写入) | 链表头部指针 |
| address | tail | 20,000 gas (首次写入) | 链表尾部指针 |
| uint256 | topCount | 20,000 gas (首次写入) | 当前链表节点数量 |

### 2. 函数 Gas 使用分析

#### 2.1 receive() 函数
- **基础成本**: 21,000 gas (交易基础费用)
- **存储更新**: 5,000 gas (SSTORE 操作)
- **函数调用**: 2,300 gas (调用 updateTop10)
- **总计**: 约 28,300 gas

#### 2.2 updateTop10() 函数
- **基础成本**: 2,300 gas (内部函数调用)
- **条件检查**: 200 gas (require 语句)
- **存储读取**: 800 gas (读取 topUsers 映射)
- **链表操作**: 5,000-15,000 gas (取决于是否需要移除/插入)
- **总计**: 约 8,300-18,300 gas

#### 2.3 remove() 函数
- **基础成本**: 2,300 gas (内部函数调用)
- **存储读取**: 800 gas (读取节点数据)
- **指针更新**: 5,000 gas (更新前后节点指针)
- **存储删除**: 15,000 gas (删除节点数据)
- **总计**: 约 23,100 gas

#### 2.4 insert() 函数
- **基础成本**: 2,300 gas (内部函数调用)
- **链表遍历**: 2,000-10,000 gas (取决于插入位置)
- **存储写入**: 20,000 gas (写入新节点)
- **指针更新**: 5,000 gas (更新前后节点指针)
- **总计**: 约 29,300-37,300 gas

#### 2.5 getTop10() 函数
- **基础成本**: 2,300 gas (view 函数)
- **数组创建**: 10,000 gas (创建返回数组)
- **链表遍历**: 5,000-50,000 gas (取决于链表长度)
- **总计**: 约 17,300-62,300 gas

### 3. 不同场景下的 Gas 消耗

#### 3.1 首次存款场景
- **receive()**: 28,300 gas
- **updateTop10()**: 8,300 gas (直接插入)
- **insert()**: 29,300 gas
- **总计**: 约 65,900 gas

#### 3.2 更新现有用户存款场景
- **receive()**: 28,300 gas
- **updateTop10()**: 18,300 gas (移除 + 插入)
- **remove()**: 23,100 gas
- **insert()**: 37,300 gas
- **总计**: 约 107,000 gas

#### 3.3 查询前10名用户场景
- **getTop10()**: 17,300-62,300 gas (取决于链表长度)

### 4. Gas 优化建议

#### 4.1 当前实现的优点
- 使用链表结构，插入和删除操作时间复杂度为 O(n)
- 只维护前10名用户，减少存储成本
- 使用 mapping 进行快速查找

#### 4.2 潜在优化点
1. **批量操作**: 考虑添加批量存款功能，减少多次调用的 gas 成本
2. **事件记录**: 添加事件记录，便于前端监听和更新
3. **访问控制**: 添加权限控制，防止恶意调用
4. **Gas 限制**: 在链表操作中添加 gas 限制，防止无限循环

### 5. 实际部署成本估算

#### 5.1 合约部署
- **合约大小**: 约 8,000 bytes
- **部署成本**: 约 1,000,000 gas
- **按 20 gwei 计算**: 约 0.02 ETH

#### 5.2 典型操作成本
- **存款操作**: 65,900-107,000 gas
- **查询操作**: 17,300-62,300 gas
- **按 20 gwei 计算**: 0.0013-0.0021 ETH (存款), 0.0003-0.0012 ETH (查询)

### 6. 总结

Bank 合约的 gas 使用相对合理，主要成本集中在链表操作上。对于前10名用户的维护，当前实现是高效的。建议在实际部署前进行充分的测试，特别是在高负载情况下的性能表现。

---
*报告生成时间: $(date)*
*合约版本: Solidity ^0.8.0*
